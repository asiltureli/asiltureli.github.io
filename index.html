<!doctype html>
<html lang="en"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><meta><title>Asil&#039;s Blog</title><link rel="manifest" href="/manifest.json"><meta name="theme-color" content="monokai"><meta name="application-name" content="Mert Asil Türeli"><meta name="msapplication-TileImage" content="/img/sincap_kucuk.png"><meta name="msapplication-TileColor" content="monokai"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-title" content="Mert Asil Türeli"><meta name="apple-mobile-web-app-status-bar-style" content="default"><meta property="og:type" content="blog"><meta property="og:title" content="Asil&#039;s Blog"><meta property="og:url" content="https://asiltureli.github.io/"><meta property="og:site_name" content="Asil&#039;s Blog"><meta property="og:locale" content="en_US"><meta property="og:image" content="https://asiltureli.github.io/img/og_image.png"><meta property="article:author" content="Mert Asil Türeli"><meta property="twitter:card" content="summary"><meta property="twitter:image:src" content="https://asiltureli.github.io/img/og_image.png"><script type="application/ld+json">{"@context":"https://schema.org","@type":"BlogPosting","mainEntityOfPage":{"@type":"WebPage","@id":"https://asiltureli.github.io"},"headline":"Asil's Blog","image":["https://asiltureli.github.io/img/og_image.png"],"author":{"@type":"Person","name":"Mert Asil Türeli"},"publisher":{"@type":"Organization","name":"Asil's Blog","logo":{"@type":"ImageObject","url":"https://asiltureli.github.io/img/sincap_kucuk.png"}},"description":""}</script><link rel="icon" href="/img/sincap_kucuk.png"><link rel="stylesheet" href="https://use.fontawesome.com/releases/v6.0.0/css/all.css"><link data-pjax rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@11.7.0/styles/monokai.css"><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Ubuntu:wght@400;600&amp;family=Source+Code+Pro"><link data-pjax rel="stylesheet" href="/css/default.css"><style>body>.footer,body>.navbar,body>.section{opacity:0}</style><!--!--><!--!--><!--!--><!--!--><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/cookieconsent@3.1.1/build/cookieconsent.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/lightgallery@1.10.0/dist/css/lightgallery.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/justifiedGallery@3.8.1/dist/css/justifiedGallery.min.css"><!--!--><!--!--><!--!--><style>.pace{-webkit-pointer-events:none;pointer-events:none;-webkit-user-select:none;-moz-user-select:none;user-select:none}.pace-inactive{display:none}.pace .pace-progress{background:#3273dc;position:fixed;z-index:2000;top:0;right:100%;width:100%;height:2px}</style><script src="https://cdn.jsdelivr.net/npm/pace-js@1.2.4/pace.min.js"></script><!--!--><!--!--><!-- hexo injector head_end start --><script>
  (function () {
      function switchTab() {
          if (!location.hash) {
            return;
          }

          const id = '#' + CSS.escape(location.hash.substring(1));
          const $tabMenu = document.querySelector(`.tabs a[href="${id}"]`);
          if (!$tabMenu) {
            return;
          }

          const $tabMenuContainer = $tabMenu.parentElement.parentElement;
          Array.from($tabMenuContainer.children).forEach($menu => $menu.classList.remove('is-active'));
          Array.from($tabMenuContainer.querySelectorAll('a'))
              .map($menu => document.getElementById($menu.getAttribute("href").substring(1)))
              .forEach($content => $content.classList.add('is-hidden'));

          if ($tabMenu) {
              $tabMenu.parentElement.classList.add('is-active');
          }
          const $activeTab = document.querySelector(id);
          if ($activeTab) {
              $activeTab.classList.remove('is-hidden');
          }
      }
      switchTab();
      window.addEventListener('hashchange', switchTab, false);
  })();
  </script><!-- hexo injector head_end end --><meta name="generator" content="Hexo 7.3.0"></head><body class="is-2-column"><nav class="navbar navbar-main"><div class="container navbar-container"><div class="navbar-brand justify-content-center"><a class="navbar-item navbar-logo" href="/"><img src="/img/sincap_kucuk.png" alt="Asil&#039;s Blog" height="28"></a></div><div class="navbar-menu"><div class="navbar-start"><a class="navbar-item is-active" href="/">Home</a><a class="navbar-item" href="/archives">Archives</a><a class="navbar-item" href="/categories">Categories</a><a class="navbar-item" href="/tags">Tags</a><a class="navbar-item" href="/about">About</a></div><div class="navbar-end"><a class="navbar-item" target="_blank" rel="noopener" title="Download on GitHub" href="https://github.com/asiltureli"><i class="fab fa-github"></i></a><a class="navbar-item search" title="Search" href="javascript:;"><i class="fas fa-search"></i></a></div></div></div></nav><section class="section"><div class="container"><div class="columns"><div class="column order-2 column-main is-8-tablet is-8-desktop is-8-widescreen"><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item">Posted&nbsp;<time dateTime="2024-11-26T18:22:48.000Z" title="11/26/2024, 7:22:48 PM">2024-11-26</time></span><span class="level-item">Updated&nbsp;<time dateTime="2025-01-18T13:22:24.412Z" title="1/18/2025, 2:22:24 PM">2025-01-18</time></span><span class="level-item">9 minutes read (About 1335 words)</span></div></div><p class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2024/11/26/gmockcatch2adapter/">The correct way to use GMock with Catch2</a></p><div class="content"><p>Hello World! In the <a href="https://asiltureli.github.io/2024/11/22/gmockcatch2danger">last post</a> I talked about the possible pitfalls of combining Catch2 with GMock. In this post I will go through the solution to this problem.</p>
<h1 id="Possible-solutions"><a href="#Possible-solutions" class="headerlink" title="Possible solutions"></a>Possible solutions</h1><p>If you stumbled upon this problem, you most probably made some research already. The useful result of this research for me was some <a target="_blank" rel="noopener" href="https://stackoverflow.com/questions/30485877/google-mock-and-catch-hpp-integration">Stackoverflow entries</a>, an important <a target="_blank" rel="noopener" href="https://github.com/matepek/catch2-with-gmock">inspiring repository</a> and the <a target="_blank" rel="noopener" href="https://chromium.googlesource.com/external/github.com/google/googletest/+/refs/tags/release-1.8.0/googlemock/docs/ForDummies.md#using-google-mock-with-any-testing-framework">Google Mock docs</a>. </p>
<p>The Google Mock documentation already mentions the issue and provides two solutions. The first, less elegant solution is to configure Google Mock to throw exceptions on failures. For me there are two problems here. The first one is already mentioned: throwing exceptions from the mock object’s destructor. The second problem (and question) is: what happens if I have multiple tests that fail in one section? Overall I directly passed that solution because the second one is way more beautiful.</p>
<p>The second solution suggests to use the Google Test’s event listener API. As I was trying to implement the whole thing and digging into the source code of Catch2 and GMock, I realized <a target="_blank" rel="noopener" href="https://chromium.googlesource.com/external/github.com/google/googletest/+/refs/tags/release-1.8.0/googlemock/docs/ForDummies.md#using-google-mock-with-any-testing-framework">this repository</a> already provides an implementation. So. my rule of thumb is to skip reinventing the wheel. Instead, honor the original creator and seek ways to make their ideas even better.</p>
<h1 id="Overriding-the-GTest’s-EventListener-class"><a href="#Overriding-the-GTest’s-EventListener-class" class="headerlink" title="Overriding the GTest’s EventListener class"></a>Overriding the GTest’s EventListener class</h1><p>The idea is very simple. GTest follows the well known <a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Observer_pattern">Observer Pattern</a> and it maintains a singleton instance called <code>listeners</code>. This is a container to hold all listeners that are interested in a possible notification (error, warning etc.). When a notification arises, such as a failed test case, every listener is notified. In the next section I will deep-dive how this is achieved, but first a listener must be implemented, which connects the GMock&#x2F;GTest and the Catch2. The goal of this listener is to create a Catch2 notification from the GMock notifications and pass it to Catch2. According to the <a target="_blank" rel="noopener" href="https://chromium.googlesource.com/external/github.com/google/googletest/+/refs/tags/release-1.8.0/googletest/docs/AdvancedGuide.md#defining-event-listeners">documentation</a> we must inherit a <code>Listener</code> from the <code>EmptyEventListener</code> class of GTest. <code>EmptyEventListener</code> is a great class, which provides virtual empty implementations for all EventListener methods, instead of leaving us with a dozen of pure virtual functions that are excited to be implemented. Therefore, we only need to implement the functions we need, which is in our case only <code>OnTestPartResult</code>.As a starting point, here is the implementation of the custom listener from the owner of the mentioned <a target="_blank" rel="noopener" href="https://github.com/matepek/catch2-with-gmock">repository</a>:</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Listener</span> : <span class="keyword">public</span> testing::EmptyTestEventListener &#123;</span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">OnTestPartResult</span><span class="params">(<span class="type">const</span> testing::TestPartResult&amp; result)</span> <span class="keyword">override</span> </span>&#123;</span><br><span class="line">      std::string filename = <span class="string">&quot;unknown&quot;</span>;</span><br><span class="line">      <span class="type">size_t</span> linenumber = <span class="number">0</span>;</span><br><span class="line">      std::string message = <span class="string">&quot;unknown&quot;</span>;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (result.<span class="built_in">file_name</span>() != <span class="literal">nullptr</span>)</span><br><span class="line">        filename = result.<span class="built_in">file_name</span>();</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (result.<span class="built_in">line_number</span>() != <span class="number">-1</span>)</span><br><span class="line">        linenumber = <span class="built_in">static_cast</span>&lt;std::<span class="type">size_t</span>&gt;(result.<span class="built_in">line_number</span>());</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (result.<span class="built_in">message</span>() != <span class="literal">nullptr</span>)</span><br><span class="line">        message = result.<span class="built_in">message</span>();</span><br><span class="line"></span><br><span class="line">      ::<span class="function">Catch::SourceLineInfo <span class="title">sourceLineInfo</span><span class="params">(filename.c_str(), linenumber)</span></span>;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (result.<span class="built_in">fatally_failed</span>()) &#123;</span><br><span class="line">        ::<span class="function">Catch::AssertionHandler <span class="title">assertion</span><span class="params">(<span class="string">&quot;GTEST&quot;</span>, sourceLineInfo, <span class="string">&quot;&quot;</span>,</span></span></span><br><span class="line"><span class="params"><span class="function">                                            ::Catch::ResultDisposition::Normal)</span></span>;</span><br><span class="line"></span><br><span class="line">        assertion.<span class="built_in">handleMessage</span>(::Catch::ResultWas::ExplicitFailure, message);</span><br><span class="line"></span><br><span class="line">        assertion.<span class="built_in">complete</span>();</span><br><span class="line">      &#125; <span class="keyword">else</span> <span class="keyword">if</span> (result.<span class="built_in">nonfatally_failed</span>()) &#123;</span><br><span class="line">        ::Catch::AssertionHandler <span class="built_in">assertion</span>(</span><br><span class="line">            <span class="string">&quot;GTEST&quot;</span>, sourceLineInfo, <span class="string">&quot;&quot;</span>,</span><br><span class="line">            ::Catch::ResultDisposition::ContinueOnFailure);</span><br><span class="line"></span><br><span class="line">        assertion.<span class="built_in">handleMessage</span>(::Catch::ResultWas::ExplicitFailure, message);</span><br><span class="line"></span><br><span class="line">        assertion.<span class="built_in">complete</span>();</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>It has some problems which we will be fixing but it is a great starting point. The code is very understandable: GTest notifies us with a <code>TestPartResult&amp; result</code> which contains information like file name, line number and the message. Depending on the error type we create either a <code>Normal</code> assertion or a <code>ContinueOnFailure</code> assertion and process it in a Catch2-way. But what are the problems in that code? There are two problems, one of them is obvious and the second one is a very sneaky one (Hint: const char*). </p>
<ol>
<li>The code only works for Catch2 v2. It required some adaptations for different versions. For example <code>assertion.setCompleted()</code> is from major version 2, which is changed to <code>assertion.completed()</code> in the version 3. Or another issue is that <code>assertion.handleMessage</code> is expecting the message as an r-value reference starting from the version <a target="_blank" rel="noopener" href="https://github.com/catchorg/Catch2/releases/tag/v3.7.1">v3.7.1</a> with the <a target="_blank" rel="noopener" href="https://github.com/catchorg/Catch2/commit/412cad546a89cda9eaa8ef77d8161b719182cc9e">related commit</a>. This code must be tested and adapted for each Catch2 version.</li>
<li>This is actually a very hard to see issue. The problem is at the constructor of the <code>AssertionHandler</code>. We create a local variable <code>filename</code> and pass the <code>const char*</code> of that variable to the constructor. However we don’t have any information what <code>assertion</code> is doing with our pointer. Eventually the usage might outlive the <code>filename</code>. The solution for this is to create a member-container that holds the <code>filename</code> for each notification. This way we can assure that the string is always there, since the listener is destroyed at the end of the program.</li>
</ol>
<p>After solving these issues our code looks like the following:</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Listener</span> : <span class="keyword">public</span> testing::EmptyTestEventListener &#123;</span><br><span class="line"></span><br><span class="line">   std::set&lt;std::string&gt; m_file_names; <span class="comment">// Solution to 2.</span></span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="type">void</span> <span class="title">OnTestPartResult</span><span class="params">(<span class="type">const</span> testing::TestPartResult&amp; result)</span> <span class="keyword">override</span></span></span><br><span class="line"><span class="function">  </span>&#123;</span><br><span class="line">    std::string filename = <span class="string">&quot;unknown&quot;</span>;</span><br><span class="line">    <span class="type">size_t</span> linenumber = <span class="number">0</span>;</span><br><span class="line">    std::string message = <span class="string">&quot;unknown&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (result.<span class="built_in">file_name</span>())</span><br><span class="line">      filename = result.<span class="built_in">file_name</span>();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (result.<span class="built_in">line_number</span>() != <span class="number">-1</span>)</span><br><span class="line">      linenumber = <span class="built_in">static_cast</span>&lt;std::<span class="type">size_t</span>&gt;(result.<span class="built_in">line_number</span>());</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (result.<span class="built_in">message</span>())</span><br><span class="line">      message = result.<span class="built_in">message</span>();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">auto</span> [it, _] = m_file_names.<span class="built_in">insert</span>(filename); <span class="comment">// Solution to 2.</span></span><br><span class="line">    ::<span class="function">Catch::SourceLineInfo <span class="title">sourceLineInfo</span><span class="params">(it-&gt;c_str(), linenumber)</span></span>; <span class="comment">// Solution to 2.</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (result.<span class="built_in">fatally_failed</span>()) &#123;</span><br><span class="line">      ::<span class="function">Catch::AssertionHandler <span class="title">assertion</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">        <span class="string">&quot;GMock&quot;</span>, sourceLineInfo, <span class="string">&quot;&quot;</span>, ::Catch::ResultDisposition::Normal)</span></span>;</span><br><span class="line"></span><br><span class="line">      assertion.<span class="built_in">handleMessage</span>(::Catch::ResultWas::ExplicitFailure,</span><br><span class="line">                              std::<span class="built_in">move</span>(message)); <span class="comment">// Solution to 1.</span></span><br><span class="line"></span><br><span class="line">      assertion.<span class="built_in">complete</span>(); <span class="comment">// Solution to 1.</span></span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (result.<span class="built_in">nonfatally_failed</span>()) &#123;</span><br><span class="line">      ::Catch::AssertionHandler <span class="built_in">assertion</span>(</span><br><span class="line">        <span class="string">&quot;GMock&quot;</span>,</span><br><span class="line">        sourceLineInfo,</span><br><span class="line">        <span class="string">&quot;&quot;</span>,</span><br><span class="line">        ::Catch::ResultDisposition::ContinueOnFailure);</span><br><span class="line"></span><br><span class="line">      assertion.<span class="built_in">handleMessage</span>(::Catch::ResultWas::ExplicitFailure,</span><br><span class="line">                              std::<span class="built_in">move</span>(message)); <span class="comment">// Solution to 1.</span></span><br><span class="line"></span><br><span class="line">      assertion.<span class="built_in">complete</span>(); <span class="comment">// Solution to 1.</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>The changes we apply include adding the <code>m_file_names</code> variable, the version specific <code>assertion.complete</code> and the changed signature of the <code>assertion.handleMessage</code> function. Be aware that this signature is only valid starting from v3.7.1.</p>
<h1 id="Adding-the-custom-Listener-to-the-GTest’s-listeners"><a href="#Adding-the-custom-Listener-to-the-GTest’s-listeners" class="headerlink" title="Adding the custom Listener to the GTest’s listeners"></a>Adding the custom Listener to the GTest’s listeners</h1><p>In the last section we created our own GTest listener, which will notify the Catch2 about the failing GMock checks. But we also need to make sure that GTest knows that we want him to notify our listener instead of some other listener object. For this purpose we will replace the default GTest listener with our listener. Here is a <code>main</code> that would solve this problem according to the <a target="_blank" rel="noopener" href="https://chromium.googlesource.com/external/github.com/google/googletest/+/refs/tags/release-1.8.0/googletest/docs/AdvancedGuide.md#using-event-listeners">event listener API</a> : </p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span>** argv)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  Catch::Session session;</span><br><span class="line">  <span class="built_in">InitGoogleMock</span>(&amp;argc, argv);</span><br><span class="line"></span><br><span class="line">  TestEventListeners&amp; gtest_listeners = UnitTest::<span class="built_in">GetInstance</span>()-&gt;<span class="built_in">listeners</span>();</span><br><span class="line">  gtest_listeners.<span class="built_in">Append</span>(<span class="keyword">new</span> <span class="built_in">GTestCatch2Listener</span>());</span><br><span class="line">  <span class="keyword">delete</span> gtest_listeners.<span class="built_in">Release</span>(</span><br><span class="line">    UnitTest::<span class="built_in">GetInstance</span>()-&gt;<span class="built_in">listeners</span>().<span class="built_in">default_result_printer</span>());</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> session.<span class="built_in">run</span>(argc, argv);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>This code achieves a very simple task. It deletes the default listener from GTest, attaches our custom listener and passes the command line arguments to GMock and Catch2. With this main and the listener it is now safe to combine GMock and Catch2. We can verify this with a new test:<br><img src="/../images/gmockcatch2adapter/test_result_solved.png" alt="(1) Failures being detected"></p>
<h1 id="Summary"><a href="#Summary" class="headerlink" title="Summary"></a>Summary</h1><p>If you have made so far, thank you for reading. In this post I introduced a way to connect GMock and Catch2. However it is still not the best solution. In the next post I will be creating a library which acts as <code>Catch2WithMain</code> which provides a pre-compiled <code>main</code> and works correctly with GMock. This way we will be able to use GMock and Catch2 only by linking against this new library. The code for this post can be found <a target="_blank" rel="noopener" href="https://github.com/asiltureli/GMockWithCatch2">here</a> Cheers.</p>
</div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item">Posted&nbsp;<time dateTime="2024-11-22T19:00:34.169Z" title="11/22/2024, 8:00:34 PM">2024-11-22</time></span><span class="level-item">Updated&nbsp;<time dateTime="2025-01-18T13:29:28.603Z" title="1/18/2025, 2:29:28 PM">2025-01-18</time></span><span class="level-item">5 minutes read (About 746 words)</span></div></div><p class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2024/11/22/gmockcatch2danger/">The danger of combining GMock with Catch2</a></p><div class="content"><p>Recently I stumbled upon a problem while writing unit tests. The unit tests I wrote were not failing even though they were supposed to fail. At first, I thought I had made a mistake in my mock classes, but the issue turned out to be completely different.</p>
<p>Catch2 is a great BDD (Behavior Driving Development) framework for C++, however it lacks a main functionality; Mocking. Therefore it would be useful to deploy GMock at this point. However this comes with a great danger. In this post I want to write about the danger and possible pitfall of combining GMock with Catch2 or possibly any other unit testing framework. </p>
<p>One might think: why not GoogleTest? The question is understandable but GTest does not offer BDD. It is designed to write TDD tests. Therefore it is a combination, which makes completely sense. </p>
<p>I will share the complete code in my repository.</p>
<h2 id="Writing-a-very-basic-mock"><a href="#Writing-a-very-basic-mock" class="headerlink" title="Writing a very basic mock"></a>Writing a very basic mock</h2><p>Let’s start with a very basic class and the mock for this class:</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">ClassToTest</span>&#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="type">void</span> <span class="title">some_call</span><span class="params">()</span></span>&#123;&#125;;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">MockClass</span> : <span class="keyword">public</span> ClassToTest&#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="built_in">MOCK_METHOD</span>(<span class="type">void</span>, some_call, (), (<span class="keyword">override</span>));</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>This should be pretty straightforward. We have a class we want to test, <code>ClassToTest</code>, and the corresponding mock class,  <code>MockClass</code>. Now, let’s add a caller for that class:</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">SimpleWrapper</span>&#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="built_in">SimpleWrapper</span>() = <span class="keyword">delete</span>;</span><br><span class="line">    <span class="built_in">SimpleWrapper</span>(ClassToTest&amp; sc) : m_obj &#123; sc &#125;&#123;&#125;;</span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">call</span><span class="params">()</span></span>&#123;m_obj.<span class="built_in">some_call</span>();&#125;;</span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    ClassToTest&amp; m_obj;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>The <code>SimpleWrapper</code> takes an <code>ClassToTest</code> as reference and allows us to call its <code>some_call</code> method. Now we are ready to test our class.</p>
<h2 id="Writing-and-running-some-tests-in-Catch2"><a href="#Writing-and-running-some-tests-in-Catch2" class="headerlink" title="Writing and running some tests in Catch2"></a>Writing and running some tests in Catch2</h2><p>In this phase we can write some tests to check our class with Catch2. Here are some very minimal tests:</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> ::testing;</span><br><span class="line"><span class="built_in">TEST_CASE</span>(<span class="string">&quot;Strict Mock Test&quot;</span>)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">auto</span> mock = <span class="built_in">StrictMock</span>&lt;MockClass&gt;();</span><br><span class="line">    <span class="keyword">auto</span> caller = <span class="built_in">SimpleWrapper</span>(mock);</span><br><span class="line"></span><br><span class="line">    caller.<span class="built_in">call</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="built_in">TEST_CASE</span>(<span class="string">&quot;Expect call&quot;</span>)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">auto</span> mock = <span class="built_in">NiceMock</span>&lt;MockClass&gt;();</span><br><span class="line">    <span class="keyword">auto</span> caller = <span class="built_in">SimpleWrapper</span>(mock);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">EXPECT_CALL</span>(mock, <span class="built_in">some_call</span>()).<span class="built_in">Times</span>(<span class="number">100</span>);</span><br><span class="line">    caller.<span class="built_in">call</span>();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>In the first test case we define a <code>StrictMock</code> and don’t set any expectations. However we call our function through our <code>SimpleWrapper</code>. The strict mock should report us the unexpected e.g. uninteresting call as an error. Therefore this is obviously a failed test case.  </p>
<p>In the second test case, we define a <code>NiceMock</code>, which doesn&#96;t affect our test case in terms of unexpected calls. The goal here is to set an expectation on <code>some_call</code>. We expect that our function gets called 100 times within this scope. However, we call it only once. This is, again, an obvious failed test case.</p>
<h2 id="Running-the-test"><a href="#Running-the-test" class="headerlink" title="Running the test"></a>Running the test</h2><p>Lets run our tests, which should obviously fail:</p>
<p><img src="/../images/gmockcatch2danger1/test_result_1_ctest.png" alt="(1) First Test Results of CTest"></p>
<p>This result is interesting and not what we would expect or want. Let’s simply run and see the output of our executable:</p>
<p><img src="/../images/gmockcatch2danger1/test_result_1_exe.png" alt="(1) First Test Results of Executable"></p>
<p>The result is still the same however we can see that something is odd. Here’s what happens: we are using the precompiled <code>main()</code> of Catch2, which simply looks something like:</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Simplified from catch2/src/catch2/internal/catch_main.cpp</span></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span> <span class="params">(<span class="type">int</span> argc, <span class="type">char</span> * argv[])</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> Catch::<span class="built_in">Session</span>().<span class="built_in">run</span>( argc, argv );</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>That means we are getting the result of our tests from <code>Catch2::Session</code>. However the question is: does Catch2 recognize that GMock&#x2F;GTest expressions are failing? The answer is <strong>NO!</strong>. The tests that are being conducted by Googletest must be passed to the Catch2. And Googletest developers have addressed this issue: </p>
<p><a target="_blank" rel="noopener" href="https://chromium.googlesource.com/external/github.com/google/googletest/+/refs/tags/release-1.8.0/googlemock/docs/ForDummies.md#using-google-mock-with-any-testing-framework">Using Google Mock with Any Testing Framework</a></p>
<p>TLDR: If you want to use GMock with other testing frameworks, it must be fine-tuned.</p>
<p>This issue is pretty obvious and straightforward after reading about it or figuring it out. However, it’s a really painful problem that will most likely cause someone to spend days trying to understand what’s happening without knowing the root cause.</p>
<h2 id="Summary"><a href="#Summary" class="headerlink" title="Summary"></a>Summary</h2><p>  Catch2 and GMock together form a very strong testing combination. However they do not work together out of the box. This might trick you into pushing a buggy code into the production.</p>
<p>  Thank you for reading. The source code for this post can be found <a target="_blank" rel="noopener" href="https://github.com/asiltureli/GMockWithCatch2">here</a> In the next post, I will go into detail on how to solve this issue.</p>
</div></article></div></div><div class="column column-left is-4-tablet is-4-desktop is-4-widescreen  order-1"><div class="card widget" data-type="profile"><div class="card-content"><nav class="level"><div class="level-item has-text-centered flex-shrink-1"><div><figure class="image is-128x128 mx-auto mb-2"><img class="avatar" src="/img/sincap_kucuk.png" alt="Mert Asil Türeli"></figure><p class="title is-size-4 is-block" style="line-height:inherit;">Mert Asil Türeli</p><p class="is-size-6 is-block">Software Developer</p><p class="is-size-6 is-flex justify-content-center"><i class="fas fa-map-marker-alt mr-1"></i><span>Berlin, Germany</span></p></div></div></nav><nav class="level is-mobile"><div class="level-item has-text-centered is-marginless"><div><p class="heading">Posts</p><a href="/archives"><p class="title">2</p></a></div></div><div class="level-item has-text-centered is-marginless"><div><p class="heading">Categories</p><a href="/categories"><p class="title">0</p></a></div></div><div class="level-item has-text-centered is-marginless"><div><p class="heading">Tag</p><a href="/tags"><p class="title">1</p></a></div></div></nav><div class="level"><a class="level-item button is-primary is-rounded" href="https://github.com/asiltureli" target="_blank" rel="me noopener">Follow</a></div><div class="level is-mobile is-multiline"><a class="level-item button is-transparent is-marginless" target="_blank" rel="me noopener" title="Github" href="https://github.com/asiltureli"><i class="fab fa-github"></i></a><a class="level-item button is-transparent is-marginless" target="_blank" rel="me noopener" title="Linkedin" href="https://linkedin.com/in/masiltureli"><i class="fab fa-linkedin"></i></a></div></div></div><!--!--><!--!--><div class="card widget" data-type="recent-posts"><div class="card-content"><h3 class="menu-label">Recents</h3><article class="media"><div class="media-content"><p class="date"><time dateTime="2024-11-26T18:22:48.000Z">2024-11-26</time></p><p class="title"><a href="/2024/11/26/gmockcatch2adapter/">The correct way to use GMock with Catch2</a></p></div></article><article class="media"><div class="media-content"><p class="date"><time dateTime="2024-11-22T19:00:34.169Z">2024-11-22</time></p><p class="title"><a href="/2024/11/22/gmockcatch2danger/">The danger of combining GMock with Catch2</a></p></div></article></div></div><div class="card widget" data-type="archives"><div class="card-content"><div class="menu"><h3 class="menu-label">Archives</h3><ul class="menu-list"><li><a class="level is-mobile" href="/archives/2024/11/"><span class="level-start"><span class="level-item">November 2024</span></span><span class="level-end"><span class="level-item tag">2</span></span></a></li></ul></div></div></div><div class="card widget" data-type="tags"><div class="card-content"><div class="menu"><h3 class="menu-label">Tags</h3><div class="field is-grouped is-grouped-multiline"><div class="control"><a class="tags has-addons" href="/tags/C/"><span class="tag">C++</span><span class="tag">2</span></a></div></div></div></div></div></div><!--!--></div></div></section><footer class="footer"><div class="container"><div class="level"><div class="level-start"><a class="footer-logo is-block mb-2" href="/"><img src="/img/sincap_kucuk.png" alt="Asil&#039;s Blog" height="28"></a><p class="is-size-7"><span>&copy; 2025 Mert Asil Türeli</span>  Powered by <a href="https://hexo.io/" target="_blank" rel="noopener">Hexo</a> &amp; <a href="https://github.com/ppoffice/hexo-theme-icarus" target="_blank" rel="noopener">Icarus</a></p></div><div class="level-end"><div class="field has-addons"><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Creative Commons" href="https://creativecommons.org/"><i class="fab fa-creative-commons"></i></a></p><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Attribution 4.0 International" href="https://creativecommons.org/licenses/by/4.0/"><i class="fab fa-creative-commons-by"></i></a></p><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Download on GitHub" href="https://github.com/asiltureli"><i class="fab fa-github"></i></a></p></div></div></div></div></footer><script src="https://cdn.jsdelivr.net/npm/jquery@3.3.1/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/moment@2.22.2/min/moment-with-locales.min.js"></script><script src="https://cdn.jsdelivr.net/npm/clipboard@2.0.4/dist/clipboard.min.js" defer></script><script>moment.locale("en");</script><script>var IcarusThemeSettings = {
            article: {
                highlight: {
                    clipboard: true,
                    fold: 'unfolded'
                }
            }
        };</script><script data-pjax src="/js/column.js"></script><script src="/js/animation.js"></script><a id="back-to-top" title="Back to top" href="javascript:;"><i class="fas fa-chevron-up"></i></a><script data-pjax src="/js/back_to_top.js" defer></script><!--!--><!--!--><!--!--><script src="https://cdn.jsdelivr.net/npm/cookieconsent@3.1.1/build/cookieconsent.min.js" defer></script><script>window.addEventListener("load", () => {
      window.cookieconsent.initialise({
        type: "info",
        theme: "edgeless",
        static: false,
        position: "bottom-left",
        content: {
          message: "This website uses cookies to improve your experience.",
          dismiss: "Got it!",
          allow: "Allow cookies",
          deny: "Decline",
          link: "Learn more",
          policy: "Cookie Policy",
          href: "https://www.cookiesandyou.com/",
        },
        palette: {
          popup: {
            background: "#edeff5",
            text: "#838391"
          },
          button: {
            background: "#4b81e8"
          },
        },
      });
    });</script><script src="https://cdn.jsdelivr.net/npm/lightgallery@1.10.0/dist/js/lightgallery.min.js" defer></script><script src="https://cdn.jsdelivr.net/npm/justifiedGallery@3.8.1/dist/js/jquery.justifiedGallery.min.js" defer></script><script>window.addEventListener("load", () => {
            if (typeof $.fn.lightGallery === 'function') {
                $('.article').lightGallery({ selector: '.gallery-item' });
            }
            if (typeof $.fn.justifiedGallery === 'function') {
                if ($('.justified-gallery > p > .gallery-item').length) {
                    $('.justified-gallery > p > .gallery-item').unwrap();
                }
                $('.justified-gallery').justifiedGallery();
            }
        });</script><!--!--><!--!--><script src="https://cdn.jsdelivr.net/npm/pjax@0.2.8/pjax.min.js"></script><script src="/js/pjax.js"></script><!--!--><!--!--><!--!--><script data-pjax src="/js/main.js" defer></script><div class="searchbox"><div class="searchbox-container"><div class="searchbox-header"><div class="searchbox-input-container"><input class="searchbox-input" type="text" placeholder="Type something..."></div><a class="searchbox-close" href="javascript:;">×</a></div><div class="searchbox-body"></div></div></div><script src="/js/insight.js" defer></script><script>document.addEventListener('DOMContentLoaded', function () {
            loadInsight({"contentUrl":"/content.json"}, {"hint":"Type something...","untitled":"(Untitled)","posts":"Posts","pages":"Pages","categories":"Categories","tags":"Tags"});
        });</script></body></html>